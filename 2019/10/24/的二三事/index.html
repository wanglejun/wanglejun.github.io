<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Android 之关于 Activity 的二三事"><meta name="keywords" content="Android"><meta name="author" content="wanglejun"><meta name="copyright" content="wanglejun"><title>Android 之关于 Activity 的二三事 | 七彩祥云至尊宝</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?60c057918ffffc2da6537ed82f0f4694";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android-之关于-Activity-的二三事"><span class="toc-number">1.</span> <span class="toc-text">Android 之关于 Activity 的二三事</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-Activity-的本质"><span class="toc-number">1.1.</span> <span class="toc-text">一 Activity 的本质</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-小结"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-Activity-组成剖析"><span class="toc-number">1.2.</span> <span class="toc-text">二 Activity 组成剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-DecorView"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 DecorView</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#角色"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简介"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">简介</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-PhoneWindow"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 PhoneWindow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#角色-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用-1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简介-1"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">简介</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-ViewRoot"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 ViewRoot</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#角色-2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用-2"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简介-2"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">简介</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-Activity-显示"><span class="toc-number">1.3.</span> <span class="toc-text">三 Activity 显示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Activity-启动"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 Activity 启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-初始化-Looper-创建消息循环"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">1.初始化 Looper 创建消息循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-接收-LAUNCH-ACTIVITY-消息"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">2.接收 LAUNCH_ACTIVITY 消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-创建-Activity-对象"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3. 创建 Activity 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-创建-PhoneWindow对象"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">5.创建 PhoneWindow对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-执行-Activity-onCreate"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">6. 执行 Activity onCreate()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-调用-setContentView"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">7. 调用 setContentView()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-执行-Activity-onResume"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">10. 执行 Activity onResume()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-添加-DecorView-到-WindowManager"><span class="toc-number">1.3.1.8.</span> <span class="toc-text">11. 添加 DecorView 到 WindowManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-初始化创建-ViewRootImpl"><span class="toc-number">1.3.1.9.</span> <span class="toc-text">12. 初始化创建 ViewRootImpl</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s2.ax1x.com/2019/03/22/A3LH3j.jpg"></div><div class="author-info__name text-center">wanglejun</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">7</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/03/22/A34iwj.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">七彩祥云至尊宝</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">首页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a></span></div><div id="post-info"><div id="post-title">Android 之关于 Activity 的二三事</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-24</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Android-之关于-Activity-的二三事"><a href="#Android-之关于-Activity-的二三事" class="headerlink" title="Android 之关于 Activity 的二三事"></a>Android 之关于 Activity 的二三事</h1><p>作为 Android 四大组件之一的 Activity 我的印象中就是用来展示界面的，在很长一段时间里，只要提及界面、UI、View 我脑子里第一个闪过的就是 Activity ，我的理解中一直认为 <code>界面、UI、View == Activity</code>。其实呢非也！如果你曾经和我一样，说起 Actvity 就是聊他的生命周期，各个方法背的滚瓜烂熟，但也仅限于此而已并没有真正的去认识 Activity 的话，那么请跟我一起从【 Activity 的组成】、【启动】、【显示】来重新认识一下 <strong>Activity</strong></p>
<h2 id="一-Activity-的本质"><a href="#一-Activity-的本质" class="headerlink" title="一 Activity 的本质"></a>一 Activity 的本质</h2><p>   首先明确一下 Activity 的基本概念，我们先来看下 Google 官方对 <a href="https://developer.android.google.cn/guide/components/activities.html" target="_blank" rel="noopener">Activity</a> 给出的定义：</p>
<blockquote>
<p>Activity 是一个应用组件，用户可与其提供的屏幕进行交互，以执行拨打电话、拍摄照片、发送电子邮件或查看地图等操作。 每个 Activity 都会获得一个用于绘制其用户界面的窗口。窗口通常会充满屏幕，但也可小于屏幕并浮动在其他窗口之上。</p>
</blockquote>
<p>读完了好像也没整明白。</p>
<p>我们抛开之前对 Activity 的印象，从代码层面上来看他就是一个普通的 Java 类，本质上并不是一个 View 或 ViewGroup，他没有继承任何 View 和 ViewGroup 相关类。</p>
<p><img src="https://s2.ax1x.com/2019/10/15/KCUNvT.png" alt="image-activity-1"><br> <a id="more"></a></p>
<p>从源码中可以看到 Activity 实现了 Window 、KeyEvent 等一系列的 Callback 以及 Listener 。看到这些大概可以知道 Activity 的职责相当于一个控制器了，接收各种回调以及处理监听事件。</p>
<p>基于 Google 官方的定义和 Activity 源码，Activity 的大概职责可以总结成一张图：</p>
<p> <img src="https://s2.ax1x.com/2019/10/16/KiG8ds.png" alt="image"></p>
<h3 id="1-1-小结"><a href="#1-1-小结" class="headerlink" title="1.1 小结"></a>1.1 小结</h3><ol>
<li>Activity 本身并不具备 View 任何属性，从代码层面看就是普通的类。</li>
<li>本身不是 View ，所以 Activity 本身并不做和 UI、视图控制相关的事，控制 UI、视图的另有其人。</li>
<li>在整体架构中扮演<code>控制器</code>角色，负责控制生命周期和事件处理。</li>
</ol>
<h2 id="二-Activity-组成剖析"><a href="#二-Activity-组成剖析" class="headerlink" title="二 Activity 组成剖析"></a>二 Activity 组成剖析</h2><p>是时候来揭开 Activity 的庐山真面目了。一图胜千言！先来看一张图。</p>
<p><img src="https://s2.ax1x.com/2019/08/20/mJ6ycV.png" alt="image"></p>
<p>上图描述了 Activity 从外到内大概的一个层级结构</p>
<h3 id="2-1-DecorView"><a href="#2-1-DecorView" class="headerlink" title="2.1 DecorView"></a>2.1 DecorView</h3><h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><p><strong><code>顶层 View</code></strong><br>当前 Activity 所有 View 的祖先， 即当前 Activity 视图树根节点。</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ol>
<li>显示 &amp; 加载布局。但其本身并不做任何 View 呈现。</li>
<li>分发 View 层事件，View 层事件由 ViewRoot 分发至 DecorView，再由 DecorView 分发给具体 View。</li>
</ol>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ol>
<li>DecorView 本质上是一个 FrameLayout ( DecorView 类继承自 FrameLayout )。</li>
<li><p>其内部包含一个竖直布局的 LinearLayout ,分为2部分：</p>
<blockquote>
<p>id 为 <code>title_container</code> 的 TitleBar 。</p>
</blockquote>
<blockquote>
<p>id 为 <code>content</code> 的 Content 。在Activity中通过 setContentView（）所设置的布局文件最终就是被添加到此处的 Content 中。</p>
</blockquote>
</li>
<li>Content 内部的视图树对应的就是 Activity 的布局文件。</li>
</ol>
<h3 id="2-2-PhoneWindow"><a href="#2-2-PhoneWindow" class="headerlink" title="2.2 PhoneWindow"></a>2.2 PhoneWindow</h3><h4 id="角色-1"><a href="#角色-1" class="headerlink" title="角色"></a>角色</h4><p><strong><code>视图承载器</code></strong>  </p>
<h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><p>承载视图 View 的显示。</p>
<h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>PhoneWindow 为 Window 的实现类。每个 Activity 均会创建一个 Window 用以承载 View ,是视图真正的控制者。</p>
<h3 id="2-3-ViewRoot"><a href="#2-3-ViewRoot" class="headerlink" title="2.3 ViewRoot"></a>2.3 ViewRoot</h3><h4 id="角色-2"><a href="#角色-2" class="headerlink" title="角色"></a>角色</h4><p><strong><code>连接器</code></strong>  </p>
<h4 id="作用-2"><a href="#作用-2" class="headerlink" title="作用"></a>作用</h4><ol>
<li>连接 <code>WindowManager</code> 和 <code>DecorView</code> 的纽带。</li>
<li>完成 View 绘制的三大流程： <code>measure</code>、<code>layout</code>、<code>draw</code>。</li>
<li>向 DecorView 分发用户发起的 View 层事件，如 KeyEvent，TouchEvent。</li>
</ol>
<h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>对应实现类为 ViewRootImpl ，实现了 ViewParent 接口。作为 WindowManagerGlobal 大部分内部实现的实际实现者，需负责与 WindowManagerService 交互通信，以调整窗口的位置大小，以及对来自 WindowManagerService 的事件（如窗口尺寸改变等）作出相应的处理。</p>
<ol>
<li><p>WindowManagerGlobal 方法实际实现如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">           Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">   ......</span><br><span class="line">   ViewRootImpl root;</span><br><span class="line">   ......</span><br><span class="line">   root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">//最终实现，调用 ViewRootImpl setView 方法。</span></span><br><span class="line">       root.setView(view, wparams, panelParentView);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">       ......</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>与 WindowManagerService 交互通信:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//与 WindowManagerService 建立远程连接</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InputMethodManager imm = InputMethodManager.getInstance();</span><br><span class="line">                IWindowManager windowManager = getWindowManagerService();</span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="三-Activity-显示"><a href="#三-Activity-显示" class="headerlink" title="三 Activity 显示"></a>三 Activity 显示</h2><p>在简单分析了 Activity 各个组成元件之后，接下来就是看这些元件是如何完成完整的 Activity 组装并将 View 呈现到用户面前。</p>
<p>一图胜千言：</p>
<p><img src="https://s2.ax1x.com/2019/10/22/K8reW8.png" alt="image"></p>
<p>下面跟随上图的流程走一遍源码（为避免篇幅过长只展示重点代码）。</p>
<h3 id="3-1-Activity-启动"><a href="#3-1-Activity-启动" class="headerlink" title="3.1 Activity 启动"></a>3.1 Activity 启动</h3><p>这部分主要做的是一些初始化设置的工作，为 Actvity 最终呈现在用户面前做准备。</p>
<h4 id="1-初始化-Looper-创建消息循环"><a href="#1-初始化-Looper-创建消息循环" class="headerlink" title="1.初始化 Looper 创建消息循环"></a>1.初始化 Looper 创建消息循环</h4><p>做为 Android 应用程序的入口类，先来看下 ActivityTread 做了什么工作。</p>
<font color="RoyalBlue"> 源码路径：ActivityTread 类 main 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">    </span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>方法解析：</strong></p>
<p>ActivityTread 的 main 方法初始化了一个 Looper消息循环用以接收主线程的操作消息。</p>
<blockquote>
<p>关于Looper消息循环详细介绍可以查看<br><a href="https://juejin.im/post/5cb05a2f5188251b0477e4a0" target="_blank" rel="noopener">Android Handler浅析</a>一文，这里就不再展开。</p>
</blockquote>
<h4 id="2-接收-LAUNCH-ACTIVITY-消息"><a href="#2-接收-LAUNCH-ACTIVITY-消息" class="headerlink" title="2.接收 LAUNCH_ACTIVITY 消息"></a>2.接收 LAUNCH_ACTIVITY 消息</h4><p>Application 启动后，主线程会收到 <code>LAUNCH_ACTIVITY</code> 消息，该消息由 ActivityTread 内部类 <code>H (继承自 Handler)</code> 接收。</p>
<font color="RoyalBlue"> 源码路径：ActivityTread/H 类 handleMessage 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">            r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">            <span class="comment">//重点看这个方法</span></span><br><span class="line">            handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收消息后会调用 <code>handleLaunchActivity()</code> 方法，下面重点都在 <code>handleLaunchActivity()</code> 方法里面了。</p>
<font color="RoyalBlue"> 源码路径：ActivityTread 类 handleLaunchActivity 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      .......</span><br><span class="line">      </span><br><span class="line">      Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">      </span><br><span class="line">          ......</span><br><span class="line">          </span><br><span class="line">          handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                  !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line">      &#125; </span><br><span class="line">      ......</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>方法解析：</strong></p>
<p>次方法内部重点看 <code>performLaunchActivity()</code> 和 <code>handleResumeActivity()</code> 方法的调用。</p>
<p>先来看 <code>performLaunchActivity()</code> 方法，此方法就开始了我们上图的<code>第 3~9</code>步的流程，直到流程走完，方法调用栈会回退至 <code>handleLaunchActivity()</code> 中继续往下执行，调用 <code>handleResumeActivity()</code>。</p>
<h4 id="3-创建-Activity-对象"><a href="#3-创建-Activity-对象" class="headerlink" title="3. 创建 Activity 对象"></a>3. 创建 Activity 对象</h4><font color="RoyalBlue"> 源码路径：ActivityTread 类 performLaunchActivity 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">       .......</span><br><span class="line">       </span><br><span class="line">       Activity activity = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//通过 Activity 类名构建 Actvity 对象</span></span><br><span class="line">           java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">           activity = mInstrumentation.newActivity(</span><br><span class="line">                   cl, component.getClassName(), r.intent);</span><br><span class="line">           </span><br><span class="line">          ......</span><br><span class="line">           </span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           .......</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           </span><br><span class="line">           ......</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">               </span><br><span class="line">               ......</span><br><span class="line">               <span class="comment">//为当前 Activity 初始一个 Window 并设置 WindowManager</span></span><br><span class="line">               activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                       r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                       r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                       r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line"></span><br><span class="line">              ......</span><br><span class="line">               </span><br><span class="line">               <span class="comment">//通过 Instrumentation 调用 Activity 的 onCreate 方法</span></span><br><span class="line">               <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                   mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">              ......</span><br><span class="line">               </span><br><span class="line">       &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          ......</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> activity;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>方法解析：</strong></p>
<p><code>performLaunchActivity</code> 方法做了三件重要的事：</p>
<ol>
<li>通过当前 Activity 的类名为当前的 Activity 创建一个对象。</li>
<li>调用 <code>activity.attach</code> 方法为当前 Activity 初始化一个 Window 对象。</li>
<li>通过 Instrumentation 调用 Activity 的 onCreate 方法。</li>
</ol>
<h4 id="5-创建-PhoneWindow对象"><a href="#5-创建-PhoneWindow对象" class="headerlink" title="5.创建 PhoneWindow对象"></a>5.创建 PhoneWindow对象</h4><p><code>performLaunchActivity</code> 方法中调用 <code>activity.attach</code> 方法为当前 Activity 初始化一个 Window 对象，我们来看下 <code>activity.attach</code> 方法的具体实现。</p>
<font color="RoyalBlue"> 源码路径：Activity 类 attach 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">                     Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">                     Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                     CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                     NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">                     Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">                     Window window, ActivityConfigCallback activityConfigCallback)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">       ......</span><br><span class="line">       <span class="comment">//为 mWindow 变量赋值，实例化一个 PhoneWindow </span></span><br><span class="line">       mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">       </span><br><span class="line">       ......</span><br><span class="line">       <span class="comment">//为 mWindow 设置 WindowManager </span></span><br><span class="line">       mWindow.setWindowManager(</span><br><span class="line">               (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">               mToken, mComponent.flattenToString(),</span><br><span class="line">               (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">       ......</span><br><span class="line">       <span class="comment">//为 mWindowManager 变量赋值</span></span><br><span class="line">       mWindowManager = mWindow.getWindowManager();</span><br><span class="line">       </span><br><span class="line">       .......</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>attach</code> 方法中为 Activity 的 mWindow 变量实例化了一个 PhoneWindow 对象，PhoneWindow 是 Window 的一个具体实现，这在上文中已经说过，就不再赘述了。</p>
<h4 id="6-执行-Activity-onCreate"><a href="#6-执行-Activity-onCreate" class="headerlink" title="6. 执行 Activity onCreate()"></a>6. 执行 Activity onCreate()</h4><p><code>performLaunchActivity</code> 方法中通过 Instrumentation 调用 Activity 的 onCreate<br>方法，该方法的具体实现在 Activity 中。<br>一般来说我们都会重写 Activity 的 onCreate 方法并在里面调用 <code>setContentView</code>。下面来看下我们熟悉的 <code>setContentView</code> 里面做了些什么。</p>
<h4 id="7-调用-setContentView"><a href="#7-调用-setContentView" class="headerlink" title="7. 调用 setContentView()"></a>7. 调用 setContentView()</h4><font color="RoyalBlue"> 源码路径：Activity 类 setContentView 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//调用 PhoneWindow 的 setContentView</span></span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Activity 的 <code>setContentView</code> 实际的实现来自 PhoneWindow，可以看下 <code>getWindow()</code> 方法返回的其实就是<code>步骤5</code>里 <code>attach</code> 方法赋值的 <code>mWindow</code> 对象。</p>
<font color="RoyalBlue"> 源码路径：Activity 类 getWindow 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Window <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> mWindow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>既然这样我们不妨跟进 PhoneWindow 中一探究竟：<br><br><font color="RoyalBlue"> 源码路径：PhoneWindow 类 setContentView 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如mContentParent为空，创建一个DecroView</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//初始化 DecroView</span></span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                getContext());</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//为 mContentParent 添加布局文件</span></span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Window.Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        <span class="comment">//内容改变回调</span></span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><strong>方法解析：</strong><br>1. <code>mContentParent</code> 这个变量就是我们上文在介绍 <code>DecroView</code> 时提到的 FrameLayout 对应的布局部分。<br>2. <code>installDecor()</code> 方法为 PhoneWindow 初始化一个 DecroView 对象。<br>3. 一番骚操作之后将当前 Activity 的布局添加至 <code>mContentParent</code> 中。<br><br>#### 8. 初始化 DecorView<br>PhoneWindow 的 setContentView 方法会为当前的 Window 初始化一个 DecorView。<br><br><font color="RoyalBlue"> 源码路径：PhoneWindow 类 installDecor 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建 DecorView 对象</span></span><br><span class="line">        mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mDecor.setWindow(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 为 DecorView 的 content 设置布局格式</span></span><br><span class="line">        mContentParent = generateLayout(mDecor);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><strong>方法解析：</strong><br><br>1.调用 <code>generateDecor</code> 方法创建 DecorView 对象，<code>generateDecor</code> 实现很简单直接。<br><br><font color="RoyalBlue"> 源码路径：PhoneWindow 类 generateDecor 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>2. 调用 <code>generateLayout</code> 方法为 DecorView 的 content 设置布局格式。<br><br><font color="RoyalBlue"> 源码路径：PhoneWindow 类 generateLayout 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取窗口样式信息</span></span><br><span class="line">    TypedArray a = getWindowStyle();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inflate the window decor.</span></span><br><span class="line">    <span class="comment">//根据主题样式，加载窗口布局</span></span><br><span class="line">    <span class="keyword">int</span> layoutResource;</span><br><span class="line">    <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mDecor.startChanging();</span><br><span class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 Decorview 对应的 content 的 FrameLayout</span></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    mDecor.finishChanging();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> contentParent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>#### 9. 添加布局到 DecorVIew Content，设置布局格式<br>这个步骤的源码<code>步骤7</code>中已经贴出来了，在 <code>setContentView</code> 方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为 mContentParent 添加布局文件</span></span><br><span class="line">mLayoutInflater.inflate(layoutResID, mContentParent);</span><br></pre></td></tr></table></figure><br><br>到这里 <code>handleLaunchActivity</code> 方法中的 <code>performLaunchActivity</code> 方法这条线就差不多走完了，现在回到 <code>handleLaunchActivity</code> 方法中继续往下执行，下面的关键方法是 <code>handleResumeActivity</code>。<br><br>### 3.2 Activity 显示<br>先看 <code>handleResumeActivity</code> 方法的重点代码。<br><br><font color="RoyalBlue"> 源码路径：ActivityThread 类 handleResumeActivity 方法。</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">    <span class="comment">// 调用Activity的onResume()</span></span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">         .......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">//添加 DecorView 到 Window</span></span><br><span class="line">                    wm.addView(decor, l);</span><br><span class="line">                &#125; </span><br><span class="line">                ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-执行-Activity-onResume"><a href="#10-执行-Activity-onResume" class="headerlink" title="10. 执行 Activity onResume()"></a>10. 执行 Activity onResume()</h4><p> <code>handleResumeActivity</code> 方法中通过调用 <code>performResumeActivity</code> 方法来执行 Activity onResume() 方法。具体实现有兴趣的可以自己跟进源码进去看下，这里就不再贴源码了，文章篇幅已经长的头皮发麻了。</p>
<h4 id="11-添加-DecorView-到-WindowManager"><a href="#11-添加-DecorView-到-WindowManager" class="headerlink" title="11. 添加 DecorView 到 WindowManager"></a>11. 添加 DecorView 到 WindowManager</h4><p><code>handleResumeActivity</code> 方法中通过调用 WindowManager 的 <code>addView</code> 方法将之前流程中已赋值的 DecorView 对象添加至当前 Window。</p>
<h4 id="12-初始化创建-ViewRootImpl"><a href="#12-初始化创建-ViewRootImpl" class="headerlink" title="12. 初始化创建 ViewRootImpl"></a>12. 初始化创建 ViewRootImpl</h4><p>初始化 ViewRootImpl 工作就是在 WindowManager 的  <code>addView</code> 方法中进行的。而 WindowManager 是一个接口，对应的实现类是 <code>WindowManagerImpl</code>，那就去 WindowManagerImpl 中找 <code>addView</code> 的具体实现咯。</p>
<font color="RoyalBlue"> 源码路径：WindowManagerImpl 类 addView 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    applyDefaultToken(params);</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><strong>方法解析：</strong><br><br><br>该方法内部直接调用 <code>WindowManagerGlobal</code> 的 <code>addView</code> 方法，WindowManager 的 <code>addView</code> 方法由 WindowManagerGlobal 代理了。<br><br><font color="RoyalBlue"> 源码路径：WindowManagerGlobal 类 addView 方法。</font><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">                    Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">   .......</span><br><span class="line"></span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">       ......</span><br><span class="line">        <span class="comment">//创建ViewRootImpl对象</span></span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//WindowManager将DecorView实例对象交给ViewRootImpl 绘制View</span></span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>#### 13. DecorView 对象传给 ViewRootImpl<br>WindowManagerGlobal 类 addView 方法在创建 ViewRootImpl 对象后调用其 <code>setView</code> 方法将将 DecorView 实例对象交给 ViewRootImpl 用以绘制 View 。<br><br><br>#### 14. 开始 View 绘制流程，呈现布局<br>所有一切准备就绪之后我们终于开始对我们 Activity 的布局进行绘制了。最终将调用<br> ViewRootImpl 的 <code>performTraversals</code>方法（此方法贼长）开始 View 绘制的三大流程，<code>measure、layout、draw</code>。<br><br><font color="RoyalBlue"> 源码路径：ViewRootImpl 类 performTraversals 方法。</font>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line">    <span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//执行测量流程</span></span><br><span class="line">    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//执行布局流程</span></span><br><span class="line">    performLayout(lp, desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//执行绘制流程</span></span><br><span class="line">    performDraw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK到此 Activity 的部件组装以及显示流程就梳理了一个大概，文章篇幅有点长，但是内容不算多，贴了很多代码，有兴趣的可以跟着我的流程自己跟进源码看下加深印象。</p>
<p>参考文献：</p>
<p><a href="https://blog.csdn.net/carson_ho/article/details/98477394" target="_blank" rel="noopener">Android：手把手带你清晰梳理自定义View的工作全流程！</a></p>
<p><a href="https://blog.csdn.net/sinat_36668731/article/details/73801356" target="_blank" rel="noopener">Android View的绘制流程</a></p>
<p><a href="https://www.cnblogs.com/kross/p/4025075.html" target="_blank" rel="noopener">Android中Activity启动过程探究</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">wanglejun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wanglejun.github.io/2019/10/24/的二三事/">https://wanglejun.github.io/2019/10/24/的二三事/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wanglejun.github.io">七彩祥云至尊宝</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2019/07/16/图解Java线程安全/"><span>图解Java线程安全</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.ax1x.com/2019/03/22/A34iwj.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By wanglejun</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>